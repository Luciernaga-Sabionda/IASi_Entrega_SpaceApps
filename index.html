<!doctype html>
<html lang="es">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>IASi – Índice de Anomalía Sísmica inteligente</title>
	<link rel="preconnect" href="https://cdn.jsdelivr.net">
	<link rel="preconnect" href="https://unpkg.com">
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
	<style>
		:root {
			--bg: #0b0f14;
			--fg: #e6edf3;
			--muted: #9fb0c0;
			--accent: #72d1ff;
			--warn: #ffd36a;
			--alert: #ff7b72;
			--ok: #8be989;
			--card: #0f1520;
			--card-2: #121a26;
		}
		html, body {
			margin: 0; padding: 0;
			background: var(--bg); color: var(--fg);
			font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
		}
		.container {
			max-width: 1200px; margin: 0 auto; padding: 16px;
		}
		header { display: flex; align-items: baseline; gap: 8px; margin-bottom: 12px; }
		header h1 { font-size: 20px; margin: 0; }
		header .tag { color: var(--muted); font-size: 13px; }
		.grid {
			display: grid; gap: 12px;
			grid-template-columns: 1.25fr 1fr;
		}
		@media (max-width: 980px) {
			.grid { grid-template-columns: 1fr; }
		}
		.card {
			background: linear-gradient(180deg, var(--card), var(--card-2));
			border: 1px solid #1a2433; border-radius: 10px; padding: 12px;
		}
		.card h3 {
			margin: 0 0 8px 0; font-size: 14px; color: var(--muted); font-weight: 600;
		}
		#map { width: 100%; height: 360px; border-radius: 8px; overflow: hidden; }
		.row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
		@media (max-width: 980px) { .row { grid-template-columns: 1fr; } }
		canvas { width: 100% !important; height: 280px !important; }
		.meta {
			display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 8px;
		}
		@media (max-width: 980px) { .meta { grid-template-columns: repeat(2, 1fr); } }
		.kpi {
			border: 1px solid #1a2433; border-radius: 8px; padding: 10px; background: #0e1622;
		}
		.kpi .label { font-size: 12px; color: var(--muted); margin-bottom: 6px; }
		.kpi .value { font-size: 18px; font-weight: 700; }
		.badge {
			display: inline-block; font-size: 12px; padding: 2px 8px; border-radius: 999px; margin-left: 6px;
			vertical-align: middle; font-weight: 600;
		}
		.badge.obs { background: rgba(139,233,137,0.12); color: var(--ok); border: 1px solid rgba(139,233,137,0.35);}
		.badge.caution { background: rgba(255,211,106,0.12); color: var(--warn); border: 1px solid rgba(255,211,106,0.35);}
		.badge.alert { background: rgba(255,123,114,0.12); color: var(--alert); border: 1px solid rgba(255,123,114,0.35);}
		.legend { font-size: 12px; color: var(--muted); display: flex; gap: 12px; margin-top: 6px; flex-wrap: wrap; }
		.dot { width: 10px; height: 10px; border-radius: 2px; display: inline-block; margin-right: 6px; vertical-align: baseline; }
		hr { border: none; border-top: 1px solid #1a2433; margin: 12px 0; }
		select, input[type="date"] {
			background: #0e1622; color: var(--fg); border: 1px solid #1a2433; border-radius: 8px; padding: 6px 8px; font-size: 13px;
		}
		.toolbar { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
		footer { color: var(--muted); font-size: 12px; margin-top: 16px; }
		a { color: var(--accent); text-decoration: none; }
		a:hover { text-decoration: underline; }

		/* Toasts y utilidades */
		.toast {
		  background:#0e1622; border:1px solid #1a2433; color:#e6edf3;
		  padding:10px 12px; border-radius:10px; min-width:240px; box-shadow:0 4px 18px rgba(0,0,0,.35);
		  font-size:13px;
		}
		.toast.error { border-color:#ff7b72; }
		.toast.info  { border-color:#72d1ff; }
		.hidden { display:none !important; }
	</style>
</head>
<body>
		<div class="container">
		<!-- Spinner global -->
		<div id="spinner" aria-live="polite" aria-busy="true" hidden
		     style="position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.35);z-index:9999">
		  <div role="status" aria-label="Cargando" style="padding:10px 14px;border-radius:10px;background:#0e1622;border:1px solid #1a2433;color:#9fb0c0">
		    Cargando…
		  </div>
		</div>

		<!-- Toasts -->
		<div id="toasts" aria-live="assertive" aria-atomic="true"
		     style="position:fixed;right:12px;bottom:12px;display:flex;flex-direction:column;gap:8px;z-index:10000"></div>
		header>
			<h1>IASi</h1>
			<span class="tag">Índice de Anomalía Sísmica inteligente</span>
			<span id="stateBadge" class="badge obs">Observación</span>
		</header>

		<div class="toolbar" style="margin-bottom:12px">
			<label>Evento:
				<select id="eventSelect" aria-label="Seleccionar evento">
					<option value="Maule_2010">Maule 2010</option>
					<option value="Valdivia_1960">Valdivia 1960</option>
					<option value="Illapel_2015">Illapel 2015</option>
					<option value="EC_CO_1906">Ecuador–Colombia 1906</option>
				</select>
			</label>
			<label>Ventana:
				<select id="windowSelect" aria-label="Seleccionar ventana">
					<option value="7">7 días</option>
					<option value="14" selected>14 días</option>
					<option value="30">30 días</option>
				</select>
			</label>
			<span class="legend">
				<span><span class="dot" style="background:#72d1ff"></span>IASi</span>
				<span><span class="dot" style="background:#8be989"></span>A</span>
				<span><span class="dot" style="background:#ffd36a"></span>R</span>
				<span><span class="dot" style="background:#ff9ee5"></span>D</span>
				<span><span class="dot" style="background:#c8b6ff"></span>M</span>
				<span><span class="dot" style="background:#ffa07a"></span>S</span>
			</span>
			<span style="flex:1 1 auto"></span>
			<small class="tag">Umbrales: Obs < 0.50 • Prec 0.50–0.69 • Alerta ≥ 0.70</small>
			<label style="display:flex;align-items:center;gap:6px">
				<small class="tag">Token:</small>
				<input id="serverToken" type="text" value="devtoken" style="width:160px" aria-label="API token">
			</label>
			<!-- Uploaders locales: iasi.json y AOI GeoJSON -->
			<label style="display:flex;align-items:center;gap:6px">
				<input id="u_iasi" type="file" accept=".json,application/json" aria-label="Cargar iasi.json local">
				<small class="tag">Cargar iasi.json</small>
			</label>
			<label style="display:flex;align-items:center;gap:6px">
				<input id="u_aoi" type="file" accept=".geojson,.json,application/geo+json" aria-label="Cargar AOI GeoJSON local">
				<small class="tag">Cargar AOI</small>
			</label>
	            <!-- Publish to server and list indices -->
				<button id="btnPublish" class="tag" style="margin-left:8px">Publicar iasi.json al servidor</button>
				<button id="btnPublishAOI" class="tag">Publicar AOI al servidor</button>
				<button id="btnListIdx" class="tag">Listar índices</button>
				<button id="btnReloadSrv" class="tag">Recargar iasi.json desde servidor</button>
		</div>

		<div class="grid">
			<div class="card">
				<h3>Mapa AOI y eventos</h3>
				<div id="map" role="img" aria-label="Mapa de AOI y epicentro"></div>
			</div>
			<div class="card">
				<h3>Contribución por señal (A/R/D/M/S)</h3>
				<canvas id="bars" role="img" aria-label="Contribución por señal"></canvas>
				<div class="meta">
					<div class="kpi"><div class="label">IASi actual</div><div id="kpiScore" class="value">—</div></div>
					<div class="kpi"><div class="label">Estado</div><div id="kpiState" class="value">—</div></div>
					<div class="kpi"><div class="label">Fecha</div><div id="kpiDate" class="value">—</div></div>
					<div class="kpi"><div class="label">Ventana</div><div id="kpiWin" class="value">14d</div></div>
				</div>
			</div>
		</div>

		<div class="row" style="margin-top:12px">
			<div class="card">
				<h3>Timeline IASi</h3>
				<canvas id="line" role="img" aria-label="Timeline IASi"></canvas>
			</div>
			<div class="card">
				<h3>Métricas rápidas</h3>
				<div class="meta">
					<div class="kpi"><div class="label">AUC‑PR</div><div id="kpiPR" class="value">—</div></div>
					<div class="kpi"><div class="label">F1</div><div id="kpiF1" class="value">—</div></div>
					<div class="kpi"><div class="label">Falsas alarmas/mes</div><div id="kpiFA" class="value">—</div></div>
					<div class="kpi"><div class="label">Lead time (días)</div><div id="kpiLT" class="value">—</div></div>
				</div>
				<hr>
				<div style="margin-bottom:8px">
					<div class="label">Pesos (weights)</div>
					<div id="weightsPanel" style="display:flex;gap:8px;margin-top:6px">
						<span class="tag">α:<span id="w_alpha">-</span></span>
						<span class="tag">β:<span id="w_beta">-</span></span>
						<span class="tag">γ:<span id="w_gamma">-</span></span>
						<span class="tag">δ:<span id="w_delta">-</span></span>
						<span class="tag">ε:<span id="w_epsilon">-</span></span>
					</div>
				</div>
				<small class="tag">Fuente de verdad: config/weights.yaml y config/thresholds.yaml</small>
			</div>
		</div>

		<footer>
			<hr>
			<div>Demo ligera. Carga iasi.json y AOI GeoJSON locales. Probabilidad, no determinismo; requiere revisión humana.</div>
		</footer>
	</div>

		<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
		<!-- Configure SERVER_BASE here if you deploy the static page to a different origin. If omitted, defaults to http://127.0.0.1:5001 -->
		<script>
		  // Allow deploy-time override by setting window.SERVER_BASE before loading the module.
			// Default placeholder. GitHub Actions can replace __SERVER_BASE__ with the secret SERVER_BASE at deploy time.
			window.SERVER_BASE = window.SERVER_BASE || '__SERVER_BASE__';
		</script>
		<script type="module" src="js/iasi-ui.js"></script>
</body>
</html>
